<!-- templates/index.html -->
<!-- –í—Å—Ç–∞–≤—Ç–µ –≤–µ—Å—å HTML –∫–æ–¥ –∑–≤—ñ–¥—Å–∏, –∞–ª–µ –∑–∞–º—ñ–Ω—ñ—Ç—å –≤—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –Ω–∞ API –∑–∞–ø–∏—Ç–∏ -->

<script>
    // ============ API CLIENT ============
    const API = {
        async login(userData) {
            return fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            }).then(r => r.json());
        },

        async addDrone(droneData) {
            return fetch('/api/drones', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(droneData)
            }).then(r => r.json());
        },

        async getFlights() {
            return fetch('/api/flights').then(r => r.json());
        },

        async addFlight(flightData) {
            return fetch('/api/flights', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(flightData)
            }).then(r => r.json());
        },

        async deleteFlight(flightId) {
            return fetch(`/api/flights/${flightId}`, {
                method: 'DELETE'
            }).then(r => r.json());
        },

        async generateMessage() {
            return fetch('/api/message/generate').then(r => r.json());
        },

        async sendTelegram(token, chatId, message) {
            return fetch('/api/message/send-telegram', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, chat_id: chatId, message })
            }).then(r => r.json());
        }
    };

    // –ó–∞–º—ñ–Ω—ñ—Ç—å —Å—Ç–∞—Ä—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –Ω–∞ –Ω–æ–≤—ñ –∑ API
    async function handleLogin() {
        const name = document.getElementById('userName').value.trim();
        const email = document.getElementById('userEmail').value.trim();
        const password = document.getElementById('userPassword').value.trim();
        const phone = document.getElementById('userPhone').value.trim();

        const result = await API.login({ name, email, password, phone });
        
        if (result.success) {
            showAlert('loginAlert', result.message, 'success');
            localStorage.setItem('userLoginData', JSON.stringify({ name, email, password, phone }));
            setTimeout(() => switchTab('flights'), 1000);
        } else {
            showAlert('loginAlert', `‚ùå ${result.message}`, 'error');
        }
    }

    async function addFlight() {
        const drone = { model: document.getElementById('droneModel').value, serial: document.getElementById('droneSerial').value };
        
        if (!drone.model || !drone.serial) {
            showAlert('flightsAlert', '‚ùå –í–∏–±–µ—Ä—ñ—Ç—å –¥—Ä–æ–Ω', 'error');
            return;
        }

        const flightData = {
            drone_model: drone.model,
            serial: drone.serial,
            location: document.getElementById('flightLocation').value.trim(),
            duration: document.getElementById('flightDuration').value,
            altitude: document.getElementById('flightAltitude').value,
            notes: document.getElementById('flightNotes').value.trim()
        };

        const result = await API.addFlight(flightData);

        if (result.success) {
            showAlert('flightsAlert', result.message, 'success');
            // –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É
            document.getElementById('flightLocation').value = '';
            document.getElementById('flightDuration').value = '';
            document.getElementById('flightAltitude').value = '';
            document.getElementById('flightNotes').value = '';
            loadFlights();
        } else {
            showAlert('flightsAlert', `‚ùå ${result.message}`, 'error');
        }
    }

    async function loadFlights() {
        const result = await API.getFlights();
        const flights = result.flights || [];
        const container = document.getElementById('flightsList');

        if (flights.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center;">–©–µ –Ω–µ–º–∞—î –¥–æ–¥–∞–Ω–∏—Ö –∑–ª—ñ—Ç—ñ–≤</p>';
            return;
        }

        container.innerHTML = flights.map(flight => `
            <div class="flight-item">
                <h4>‚úàÔ∏è ${flight.location}</h4>
                <p><strong>–ú–æ–¥–µ–ª—å –¥—Ä–æ–Ω–∞:</strong> ${flight.drone}</p>
                <p><strong>–°–µ—Ä—ñ–π–Ω–∏–π –Ω–æ–º–µ—Ä:</strong> <code>${flight.serial}</code></p>
                <p><strong>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å:</strong> ${flight.duration} —Ö–≤–∏–ª–∏–Ω</p>
                <p><strong>–í–∏—Å–æ—Ç–∞:</strong> ${flight.altitude} –º–µ—Ç—Ä—ñ–≤</p>
                ${flight.notes ? `<p><strong>–ü—Ä–∏–º—ñ—Ç–∫–∏:</strong> ${flight.notes}</p>` : ''}
                <p><small>‚è∞ ${flight.timestamp}</small></p>
                <button class="btn-danger" onclick="deleteFlight(${flight.id})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </div>
        `).join('');
    }

    async function deleteFlight(id) {
        if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')) {
            const result = await API.deleteFlight(id);
            if (result.success) {
                showAlert('flightsAlert', result.message, 'success');
                loadFlights();
            }
        }
    }

    async function sendToTelegram() {
        const token = document.getElementById('telegramToken').value.trim();
        const chatId = document.getElementById('telegramChatId').value.trim();
        const message = document.getElementById('telegramMessage').value.trim();

        if (!token || !chatId) {
            showAlert('messageAlert', '‚ùå –í–≤–µ–¥—ñ—Ç—å —Ç–æ–∫–µ–Ω —Ç–∞ Chat ID', 'error');
            return;
        }

        showAlert('messageAlert', 'üì§ –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è...', 'warning');
        const result = await API.sendTelegram(token, chatId, message);

        if (result.success) {
            showAlert('messageAlert', result.message, 'success');
        } else {
            showAlert('messageAlert', `‚ùå ${result.message}`, 'error');
        }
    }
</script>